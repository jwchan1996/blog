(window.webpackJsonp=window.webpackJsonp||[]).push([[4],{371:function(t,a,s){t.exports=s.p+"assets/img/01.27534f0c.png"},372:function(t,a,s){t.exports=s.p+"assets/img/02.6741028e.png"},373:function(t,a,s){t.exports=s.p+"assets/img/03.28824ba9.png"},374:function(t,a,s){t.exports=s.p+"assets/img/04.7d12be89.png"},375:function(t,a,s){t.exports=s.p+"assets/img/05.954fd6a0.png"},376:function(t,a,s){t.exports=s.p+"assets/img/06.3f8f1985.png"},377:function(t,a,s){t.exports=s.p+"assets/img/07.92b5dbf5.png"},378:function(t,a,s){t.exports=s.p+"assets/img/08.c7c8e014.png"},430:function(t,a,s){"use strict";s.r(a);var n=s(43),e=Object(n.a)({},(function(){var t=this,a=t.$createElement,n=t._self._c||a;return n("ContentSlotsDistributor",{attrs:{"slot-key":t.$parent.slotKey}},[n("h1",{attrs:{id:"centos7-使用-docker-部署-gitlab-gitlab-runner"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#centos7-使用-docker-部署-gitlab-gitlab-runner"}},[t._v("#")]),t._v(" centos7 使用 docker 部署 gitlab + gitlab-runner")]),t._v(" "),n("h2",{attrs:{id:"快速配置应用"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#快速配置应用"}},[t._v("#")]),t._v(" 快速配置应用")]),t._v(" "),n("h3",{attrs:{id:"docker-compose-yml"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#docker-compose-yml"}},[t._v("#")]),t._v(" docker-compose.yml")]),t._v(" "),n("p",[t._v("使用 "),n("code",[t._v("docker-compose")]),t._v(" 对 "),n("code",[t._v("docker")]),t._v(" 容器集群进行快速编排")]),t._v(" "),n("p",[t._v("获取 "),n("code",[t._v("docker-gitlab")]),t._v(" 的 "),n("code",[t._v("docker-compose.yml")]),t._v(" 配置文件，进行快速构建")]),t._v(" "),n("div",{staticClass:"language-bash extra-class"},[n("pre",{pre:!0,attrs:{class:"language-bash"}},[n("code",[t._v("$ "),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("wget")]),t._v(" https://raw.githubusercontent.com/sameersbn/docker-gitlab/master/docker-compose.yml\n")])])]),n("p",[t._v("获取 "),n("code",[t._v("docker-compose.yml")]),t._v(" 文件后，进行自定义配置。")]),t._v(" "),n("h3",{attrs:{id:"配置环境"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#配置环境"}},[t._v("#")]),t._v(" 配置环境")]),t._v(" "),n("p",[t._v("打开 "),n("code",[t._v("docker-compose.yml")]),t._v(" 文件，针对 "),n("code",[t._v("gitlab")]),t._v(" 进行环境配置")]),t._v(" "),n("div",{staticClass:"language-yaml extra-class"},[n("pre",{pre:!0,attrs:{class:"language-yaml"}},[n("code",[n("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("version")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token string"}},[t._v("'2.3'")]),t._v("\n\n"),n("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("services")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n  \n  "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("...")]),t._v("\n  "),n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# 省略显示其他服务")]),t._v("\n  "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("...")]),t._v("\n  \n  "),n("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("gitlab")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n    "),n("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("restart")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" always\n    "),n("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("image")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" sameersbn/gitlab"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("13.0.6\n    "),n("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("depends_on")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n    "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" redis\n    "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" postgresql\n    "),n("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("ports")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n    "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token string"}},[t._v('"10080:80"')]),t._v("\n    "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token string"}},[t._v('"10022:22"')]),t._v("\n    "),n("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("volumes")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n    "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" gitlab"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v("data"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("/home/git/data"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("Z\n    "),n("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("healthcheck")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n      "),n("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("test")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),n("span",{pre:!0,attrs:{class:"token string"}},[t._v('"CMD"')]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token string"}},[t._v('"/usr/local/sbin/healthcheck"')]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v("\n      "),n("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("interval")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" 5m\n      "),n("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("timeout")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" 10s\n      "),n("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("retries")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token number"}},[t._v("3")]),t._v("\n      "),n("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("start_period")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" 5m\n    "),n("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("environment")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n    "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" DEBUG=false\n\n    "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" DB_ADAPTER=postgresql\n    "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" DB_HOST=postgresql\n    "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" DB_PORT=5432\n    "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" DB_USER=gitlab\n    "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" DB_PASS=password\n    "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" DB_NAME=gitlabhq_production\n\n    "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" REDIS_HOST=redis\n    "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" REDIS_PORT=6379\n\n    "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" TZ=Asia/Kolkata\n    "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" GITLAB_TIMEZONE=Kolkata\n\n    "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" GITLAB_HTTPS=false\n    "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" SSL_SELF_SIGNED=false\n\n    "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" GITLAB_HOST=localhost\n    "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" GITLAB_PORT=10080\n    "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" GITLAB_SSH_PORT=10022\n    "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" GITLAB_RELATIVE_URL_ROOT=\n    "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" GITLAB_SECRETS_DB_KEY_BASE=long"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v("and"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v("random"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v("alphanumeric"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v("string\n    "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" GITLAB_SECRETS_SECRET_KEY_BASE=long"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v("and"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v("random"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v("alphanumeric"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v("string\n    "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" GITLAB_SECRETS_OTP_KEY_BASE=long"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v("and"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v("random"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v("alphanumeric"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v("string\n\n    "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("...")]),t._v("\n    "),n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# 省略其他配置")]),t._v("\n    "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("...")]),t._v("\n")])])]),n("p",[t._v("参考"),n("a",{attrs:{href:"https://github.com/sameersbn/docker-gitlab/",target:"_blank",rel:"noopener noreferrer"}},[t._v("配置文档"),n("OutboundLink")],1),t._v("，我们需要将时区设置为东八时区，设置数据混淆密匙，设置服务地址。")]),t._v(" "),n("div",{staticClass:"language-yaml extra-class"},[n("pre",{pre:!0,attrs:{class:"language-yaml"}},[n("code",[n("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("environment")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" TZ=Asia/Shanghai\n"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" GITLAB_TIMEZONE=Asia/Shanghai\n\n"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" GITLAB_HOST=192.168.2.192\n")])])]),n("p",[t._v("设置混淆密匙，一般推荐 "),n("code",[t._v("64")]),t._v(" 位随机字符串，可以用 "),n("code",[t._v("pwgen")]),t._v(" 生成，可以安装 "),n("code",[t._v("pwgen")]),t._v(" 服务，然后运行 "),n("code",[t._v("pwgen -Bsv1 64")]),t._v(" 即可生成随机字符串。")]),t._v(" "),n("div",{staticClass:"language-yaml extra-class"},[n("pre",{pre:!0,attrs:{class:"language-yaml"}},[n("code",[n("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("environment")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" GITLAB_SECRETS_DB_KEY_BASE=nvqgzJdgrmr3tqsC4F9gKVNhKvTq3N7cJPjNggR93qthNhJ3MWkc7jNmNTLRXdhX\n"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" GITLAB_SECRETS_SECRET_KEY_BASE=pcrf73fX4rM7bKxc7tcq3kwKWdtKKtrmmsHwT3J9rwCLMsK37PxCnXbMgnRpqJbk\n"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" GITLAB_SECRETS_OTP_KEY_BASE=3d9tPCzpv7rfmVgnjN9McbztRVbp4rjxWWqFbNLTCbRz9mKkpvqqWgxMq7NM7c9w\n")])])]),n("p",[t._v("同理，"),n("code",[t._v("docker-compose.yml")]),t._v(" 的其他服务也需要配置东八时区。")]),t._v(" "),n("h3",{attrs:{id:"数据卷挂载"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#数据卷挂载"}},[t._v("#")]),t._v(" 数据卷挂载")]),t._v(" "),n("p",[t._v("数据卷挂载可对数据进行持久化保存，不会因为容器的删除而删除，数据挂载的目录数据会自动与容器内的数据同步，数据挂载的目录数据优先于容器内数据，即修改数据卷数据，会自动同步到容器内数据。")]),t._v(" "),n("div",{staticClass:"language-yaml extra-class"},[n("pre",{pre:!0,attrs:{class:"language-yaml"}},[n("code",[n("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("version")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token string"}},[t._v("'2.3'")]),t._v("\n\n"),n("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("services")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n  "),n("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("redis")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n    "),n("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("restart")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" always\n    "),n("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("image")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" redis"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("5.0.9\n    "),n("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("command")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n    "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v("loglevel warning\n    "),n("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("volumes")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n    "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" redis"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v("data"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("/var/lib/redis"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("Z\n    "),n("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("environment")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n    "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" TZ=Asia/Shanghai\n\n  "),n("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("postgresql")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n    "),n("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("restart")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" always\n    "),n("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("image")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" sameersbn/postgresql"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("11"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),n("span",{pre:!0,attrs:{class:"token number"}},[t._v("20200524")]),t._v("\n    "),n("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("volumes")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n    "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" postgresql"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v("data"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("/var/lib/postgresql"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("Z\n    "),n("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("environment")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n    "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" DB_USER=gitlab\n    "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" DB_PASS=password\n    "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" DB_NAME=gitlabhq_production\n    "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" DB_EXTENSION=pg_trgm\n    "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" TZ=Asia/Shanghai\n\n  "),n("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("gitlab")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n    "),n("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("restart")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" always\n    "),n("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("image")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" sameersbn/gitlab"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("13.0.6\n    "),n("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("depends_on")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n    "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" redis\n    "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" postgresql\n    "),n("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("ports")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n    "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token string"}},[t._v('"10080:80"')]),t._v("\n    "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token string"}},[t._v('"10022:22"')]),t._v("\n    "),n("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("volumes")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n    "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" gitlab"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v("data"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("/home/git/data"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("Z\n    "),n("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("healthcheck")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n      "),n("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("test")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),n("span",{pre:!0,attrs:{class:"token string"}},[t._v('"CMD"')]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token string"}},[t._v('"/usr/local/sbin/healthcheck"')]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v("\n      "),n("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("interval")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" 5m\n      "),n("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("timeout")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" 10s\n      "),n("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("retries")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token number"}},[t._v("3")]),t._v("\n      "),n("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("start_period")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" 5m\n")])])]),n("p",[t._v("注意：数据卷的挂载，需要在宿主机提前创建好对应的目录。")]),t._v(" "),n("p",[t._v("手动创建以下目录：")]),t._v(" "),n("div",{staticClass:"language- extra-class"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[t._v("/app/volumes/gitlab/gitlab/\n/app/volumes/gitlab/postgresql/\n/app/volumes/gitlab/redis/\n")])])]),n("p",[t._v("修改对应数据卷配置：")]),t._v(" "),n("div",{staticClass:"language-yaml extra-class"},[n("pre",{pre:!0,attrs:{class:"language-yaml"}},[n("code",[n("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("redis")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n    "),n("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("restart")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" always\n    "),n("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("image")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" redis"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("5.0.9\n    "),n("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("command")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n    "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v("loglevel warning\n    "),n("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("volumes")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n    "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" /app/volumes/gitlab/redis"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("/var/lib/redis"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("Z\n")])])]),n("div",{staticClass:"language-yaml extra-class"},[n("pre",{pre:!0,attrs:{class:"language-yaml"}},[n("code",[n("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("postgresql")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n    "),n("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("restart")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" always\n    "),n("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("image")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" sameersbn/postgresql"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("11"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),n("span",{pre:!0,attrs:{class:"token number"}},[t._v("20200524")]),t._v("\n    "),n("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("volumes")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n    "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" /app/volumes/gitlab/postgresql"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("/var/lib/postgresql"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("Z\n")])])]),n("div",{staticClass:"language-yaml extra-class"},[n("pre",{pre:!0,attrs:{class:"language-yaml"}},[n("code",[n("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("gitlab")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n    "),n("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("restart")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" always\n    "),n("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("image")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" sameersbn/gitlab"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("13.0.6\n    "),n("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("depends_on")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n    "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" redis\n    "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" postgresql\n    "),n("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("ports")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n    "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token string"}},[t._v('"10080:80"')]),t._v("\n    "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token string"}},[t._v('"10022:22"')]),t._v("\n    "),n("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("volumes")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n    "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" /app/volumes/gitlab/gitlab"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("/home/git/data"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("Z\n")])])]),n("h3",{attrs:{id:"gitlab-runner"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#gitlab-runner"}},[t._v("#")]),t._v(" gitlab-runner")]),t._v(" "),n("p",[t._v("拉下来的 "),n("code",[t._v("docker-compose.yml")]),t._v(" 文件默认是没有 "),n("code",[t._v("gitlab-runner")]),t._v(" 的，我们需要将 "),n("code",[t._v("gitlab-runner")]),t._v(" 写到 "),n("code",[t._v("docker-compose.yml")]),t._v(" 配置上来。")]),t._v(" "),n("p",[t._v("也要先创建数据卷挂载文件目录：")]),t._v(" "),n("div",{staticClass:"language- extra-class"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[t._v("/app/volumes/gitlab-runner/config/\n")])])]),n("div",{staticClass:"language-yaml extra-class"},[n("pre",{pre:!0,attrs:{class:"language-yaml"}},[n("code",[n("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("gitlab-runner")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" \n    "),n("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("restart")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" always\n    "),n("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("image")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" gitlab/gitlab"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v("runner\n    "),n("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("depends_on")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n    "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" gitlab\n    "),n("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("volumes")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n    "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" /app/volumes/gitlab"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v("runner/config"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("/etc/gitlab"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v("runner"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("Z\n    "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" /var/run/docker.sock"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("/var/run/docker.sock\n    "),n("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("environment")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n    "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" TZ=Asia/Shanghai\n")])])]),n("h2",{attrs:{id:"快速构建应用"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#快速构建应用"}},[t._v("#")]),t._v(" 快速构建应用")]),t._v(" "),n("p",[t._v("将配置好的 "),n("code",[t._v("docker-compose.yml")]),t._v(" 文件放到 "),n("code",[t._v("/app/docker/gitlab/")]),t._v(" 下，执行以下命令：")]),t._v(" "),n("div",{staticClass:"language-bash extra-class"},[n("pre",{pre:!0,attrs:{class:"language-bash"}},[n("code",[t._v("$ "),n("span",{pre:!0,attrs:{class:"token builtin class-name"}},[t._v("cd")]),t._v(" /app/docker/gitlab/\n$ docker-compose up\n")])])]),n("p",[n("code",[t._v("docker-compose")]),t._v(" 会自动管理 "),n("code",[t._v("docker")]),t._v(" 容器集群，包括对镜像进行拉取、创建以及启动。")]),t._v(" "),n("p",[t._v("稍等片刻，我们即可通过 "),n("code",[t._v("http://192.168.2.192:10080/")]),t._v(" 打开 "),n("code",[t._v("gitlab")]),t._v(" 页面，第一次打开是直接设置 "),n("code",[t._v("root")]),t._v(" 账号的密码，设置密码后即可登录进入 "),n("code",[t._v("gitlab")]),t._v(" 内页。")]),t._v(" "),n("p",[t._v("英文不好的同学可以进入个人设置那里设置 "),n("code",[t._v("language")]),t._v(" 为简体中文。")]),t._v(" "),n("p",[n("img",{attrs:{src:s(371),alt:"设置语言"}})]),t._v(" "),n("h3",{attrs:{id:"注册runner"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#注册runner"}},[t._v("#")]),t._v(" 注册runner")]),t._v(" "),n("p",[t._v("什么是 "),n("code",[t._v("runner")]),t._v("，"),n("code",[t._v("runner")]),t._v(" 就是 "),n("code",[t._v("gitlab")]),t._v(" 进行可持续集成与可持续交付过程所跑的环境容器服务。")]),t._v(" "),n("p",[t._v("为了进行 "),n("code",[t._v("ci/cd")]),t._v(" => 可持续集成/可持续部署，我们需要注册 "),n("code",[t._v("runner")]),t._v("，一般我们注册的是共享 "),n("code",[t._v("runner")]),t._v("，也就是任何仓库的 "),n("code",[t._v("ci/cd")]),t._v(" 都可以在上面跑。当然，我们也可以创建多个 "),n("code",[t._v("runner")]),t._v(" 服务，为特定仓库指定 "),n("code",[t._v("runner")]),t._v("。")]),t._v(" "),n("p",[t._v("下面以注册共享 "),n("code",[t._v("runner")]),t._v(" 为例：")]),t._v(" "),n("p",[n("img",{attrs:{src:s(372),alt:"runner列表"}})]),t._v(" "),n("p",[t._v("比如")]),t._v(" "),n("ol",[n("li",[t._v("进入 "),n("code",[t._v("runner")]),t._v(" 容器")])]),t._v(" "),n("div",{staticClass:"language-bash extra-class"},[n("pre",{pre:!0,attrs:{class:"language-bash"}},[n("code",[t._v("$ docker "),n("span",{pre:!0,attrs:{class:"token builtin class-name"}},[t._v("exec")]),t._v(" -it 容器ID "),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("bash")]),t._v("\n")])])]),n("ol",{attrs:{start:"2"}},[n("li",[t._v("注册 "),n("code",[t._v("runner")])])]),t._v(" "),n("div",{staticClass:"language-bash extra-class"},[n("pre",{pre:!0,attrs:{class:"language-bash"}},[n("code",[t._v("$ gitlab-runner register\n")])])]),n("ol",{attrs:{start:"3"}},[n("li",[t._v("输入 "),n("code",[t._v("gitlab")]),t._v(" 示例的 "),n("code",[t._v("url")])])]),t._v(" "),n("div",{staticClass:"language-bash extra-class"},[n("pre",{pre:!0,attrs:{class:"language-bash"}},[n("code",[t._v(" $ Please enter the gitlab-ci coordinator URL "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("e.g. https://gitlab.com "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(":\n http://192.168.2.192:10080/\n")])])]),n("ol",{attrs:{start:"4"}},[n("li",[t._v("输入用来注册 "),n("code",[t._v("runner")]),t._v(" 的 "),n("code",[t._v("token")])])]),t._v(" "),n("div",{staticClass:"language-bash extra-class"},[n("pre",{pre:!0,attrs:{class:"language-bash"}},[n("code",[t._v("$ Please enter the gitlab-ci token "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("for")]),t._v(" this runner:\nyrErncrc8XY_e5-g7bU8\n")])])]),n("ol",{attrs:{start:"5"}},[n("li",[t._v("输入 "),n("code",[t._v("runner")]),t._v(" 的描述，随后可在 "),n("code",[t._v("gitlab")]),t._v(" 界面中修改")])]),t._v(" "),n("div",{staticClass:"language-bash extra-class"},[n("pre",{pre:!0,attrs:{class:"language-bash"}},[n("code",[t._v("$ Please enter the gitlab-ci description "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("for")]),t._v(" this runner:\ngitlab-ci\n")])])]),n("ol",{attrs:{start:"6"}},[n("li",[t._v("输入与 "),n("code",[t._v("runner")]),t._v(" 绑定的标签（可修改）")])]),t._v(" "),n("div",{staticClass:"language-bash extra-class"},[n("pre",{pre:!0,attrs:{class:"language-bash"}},[n("code",[t._v("$ Please enter the gitlab-ci tags "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("for")]),t._v(" this runner "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("comma separated"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(":\ngitlab-ci\n")])])]),n("ol",{attrs:{start:"7"}},[n("li",[t._v("选择 "),n("code",[t._v("runner")]),t._v(" 的执行方式（推荐"),n("code",[t._v("docker")]),t._v("）")])]),t._v(" "),n("div",{staticClass:"language- extra-class"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[t._v(" $ Please enter the executor: ssh, docker+machine, docker-ssh+machine, kubernetes, docker, parallels, virtualbox, docker-ssh, shell:\n docker\n\n")])])]),n("ol",{attrs:{start:"8"}},[n("li",[t._v("如果选择的执行方式是 "),n("code",[t._v("docker")]),t._v("，会要求填写默认的镜像")])]),t._v(" "),n("div",{staticClass:"language-bash extra-class"},[n("pre",{pre:!0,attrs:{class:"language-bash"}},[n("code",[t._v("$ Please enter the Docker image "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("eg. ruby:2.1"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(":\nalpine:latest\n")])])]),n("p",[t._v("注册成功后会在 "),n("code",[t._v("runner")]),t._v(" 容器 "),n("code",[t._v("~/etc/gitlab-runner/")]),t._v(" 目录下生成 "),n("code",[t._v("config.toml")]),t._v(" 配置文件，这时候就可以在 "),n("code",[t._v("gitlab")]),t._v(" 的管理页面中看到激活的 "),n("code",[t._v("runner")])]),t._v(" "),n("p",[n("img",{attrs:{src:s(373),alt:"激活的runner"}})]),t._v(" "),n("p",[t._v("然后，对 "),n("code",[t._v("runner")]),t._v(" 进行修改，勾选 "),n("code",[t._v("runner 可以选择无标签的项目")]),t._v("（默认是同样标签的项目才能使用对应标签的 "),n("code",[t._v("runner")]),t._v("）。这样，"),n("code",[t._v("runner")]),t._v(" 就可以变为共享 "),n("code",[t._v("runner")]),t._v(" 了。")]),t._v(" "),n("p",[t._v("当我们需要专门为某个项目跑的 "),n("code",[t._v("runner")]),t._v(" 时，那就不需要勾选 "),n("code",[t._v("runner")]),t._v(" 可选择无标签选项，在下面配置添加 "),n("code",[t._v("runner")]),t._v(" 服务的项目保存即可。")]),t._v(" "),n("p",[n("img",{attrs:{src:s(374),alt:"配置runner共享"}})]),t._v(" "),n("h2",{attrs:{id:"可持续集成-部署"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#可持续集成-部署"}},[t._v("#")]),t._v(" 可持续集成/部署")]),t._v(" "),n("p",[t._v("可持续集成与部署需要配置 "),n("code",[t._v(".gitlab-ci.yml")]),t._v(" 文件，"),n("code",[t._v("gitlab")]),t._v(" 会检查每个仓库根目录是否存在 "),n("code",[t._v(".gitlab-ci.yml")]),t._v(" 文件，有的话 "),n("code",[t._v("runner")]),t._v(" 则自动跑起来。")]),t._v(" "),n("blockquote",[n("p",[t._v("runner 会根据 .gitlab-ci.yml 文件配置，在宿主机创建容器，根据配置步骤一步步进行构建任务，构建成功或失败都会自动销毁容器。")])]),t._v(" "),n("p",[n("code",[t._v("gitlab")]),t._v(" 默认开启 "),n("code",[t._v("auto devops")]),t._v(" 功能，如果没有 "),n("code",[t._v(".gitlab-ci.yml")]),t._v(" 文件，则会自动运行 "),n("code",[t._v("auto devops")]),t._v("，如果没有配置 "),n("code",[t._v("Auto DevOps")]),t._v(" 功能与 "),n("code",[t._v("Kubernetes")]),t._v(" 集成的话，建议关闭默认的 "),n("code",[t._v("auto devops")]),t._v(" 功能。")]),t._v(" "),n("p",[n("img",{attrs:{src:s(375),alt:"关闭默认"}})]),t._v(" "),n("h3",{attrs:{id:"gitlab-ci-yml"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#gitlab-ci-yml"}},[t._v("#")]),t._v(" .gitlab-ci.yml")]),t._v(" "),n("p",[t._v("这是一个自动编译前端代码并发布到 "),n("code",[t._v("gitlab page")]),t._v(" 的配置文件：")]),t._v(" "),n("div",{staticClass:"language-yaml extra-class"},[n("pre",{pre:!0,attrs:{class:"language-yaml"}},[n("code",[n("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("building")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" \n  "),n("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("image")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" node"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("alpine    "),n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# 指定运行环境")]),t._v("\n  "),n("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("stage")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" build          "),n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# 当前stage阶段为build")]),t._v("\n  "),n("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("script")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("               "),n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# build阶段运行的脚本")]),t._v("\n    "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" yarn "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v("registry=https"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("//registry.npm.taobao.org\n    "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" yarn docs"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("build\n  "),n("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("artifacts")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("            "),n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# 工件，可以缓存在gitlab的流水线记录中，供直接下载")]),t._v("\n    "),n("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("expire_in")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" 3 days   "),n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# 工件缓存的有效时间")]),t._v("\n    "),n("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("paths")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("              "),n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# 路径")]),t._v("\n      "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" docs/.vuepress/dist/            "),n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# 工件指向的目录，这里指整个dist目录")]),t._v("\n\n"),n("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("cache")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("                  "),n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# 缓存")]),t._v("\n  "),n("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("paths")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("                "),n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# 路径")]),t._v("\n    "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" node_modules/     "),n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# 缓存node_mudules将大大提高ci运行的速度")]),t._v("\n\n"),n("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("deploying")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" \n  "),n("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("stage")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" deploy         "),n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# 当前阶段为deploy")]),t._v("\n  "),n("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("script")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("               "),n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# deploy阶段运行的命令")]),t._v("\n    "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" rm "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v("rf public/*   "),n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# linux命令，递归无询问删除public目录下所有文件- mv dist/* public //将dist目录下的所有文件都移动到public目录下")]),t._v("\n  "),n("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("artifacts")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("            "),n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# 工件缓存")]),t._v("\n    "),n("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("expire_in")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" 3 days   "),n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# 时效为3天")]),t._v("\n    "),n("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("paths")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("              "),n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# 路径")]),t._v("\n      "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" public          "),n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# 缓存整个public目录的文件")]),t._v("\n  "),n("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("only")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" \n    "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" master               "),n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# ceate pages下的所有操作只在 master 分支上进行")]),t._v("\n\n")])])]),n("h3",{attrs:{id:"自动化"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#自动化"}},[t._v("#")]),t._v(" 自动化")]),t._v(" "),n("p",[t._v("当我们提交我们的代码后，"),n("code",[t._v("gitlab")]),t._v(" 会自动根据 "),n("code",[t._v(".gitlab-ci.yml")]),t._v(" 的配置运行 "),n("code",[t._v("runner")]),t._v("。")]),t._v(" "),n("p",[n("img",{attrs:{src:s(376),alt:"提交代码"}})]),t._v(" "),n("p",[n("img",{attrs:{src:s(377),alt:"运行通过"}})]),t._v(" "),n("p",[t._v("这样我们就实现自动化集成与部署了，大大的提高了我们的开发效率。")]),t._v(" "),n("h2",{attrs:{id:"身份认证"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#身份认证"}},[t._v("#")]),t._v(" 身份认证")]),t._v(" "),n("p",[t._v("我们在 "),n("code",[t._v("gitlab")]),t._v(" 上注册了自己的账号后，为了方便身份认证，一般需要用 "),n("code",[t._v("ssh")]),t._v(" 生成身份认证密匙，这样就不需要每次访问都要输入账号密码。")]),t._v(" "),n("h3",{attrs:{id:"配置shh密匙"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#配置shh密匙"}},[t._v("#")]),t._v(" 配置SHH密匙")]),t._v(" "),n("p",[t._v("在我们的电脑 "),n("code",[t._v("git bash")]),t._v(" 输入：")]),t._v(" "),n("div",{staticClass:"language-bash extra-class"},[n("pre",{pre:!0,attrs:{class:"language-bash"}},[n("code",[t._v("$ ssh-keygen -t rsa -C "),n("span",{pre:!0,attrs:{class:"token string"}},[t._v('"我们在gitlab注册的邮箱"')]),t._v(" -f ~/.ssh/gitlab_id_rsa\n")])])]),n("p",[t._v("此时会在我们电脑用户根目录的 "),n("code",[t._v("/.ssh")]),t._v(" 下生成私匙跟公匙：")]),t._v(" "),n("div",{staticClass:"language- extra-class"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[t._v("gitlab_id_rsa\ngitlab_id_rsa.pub\n")])])]),n("p",[t._v("打开 "),n("code",[t._v("pub")]),t._v(" 后缀的公匙，复制粘贴到 "),n("code",[t._v("gitlab")]),t._v(" 用户设置，保存即可。")]),t._v(" "),n("p",[n("img",{attrs:{src:s(378),alt:"身份认证"}})]),t._v(" "),n("p",[t._v("在对 "),n("code",[t._v("gitlab")]),t._v(" 仓库使用 "),n("code",[t._v("git")]),t._v(" 命令的时候，如果出现提示没有权限的话，多半是因为 "),n("code",[t._v("git")]),t._v(" 混淆了 "),n("code",[t._v("github")]),t._v(" 与 "),n("code",[t._v("gitlab")]),t._v(" 的 "),n("code",[t._v("ssh")]),t._v(" 密钥，解决方法看下一步。")]),t._v(" "),n("h3",{attrs:{id:"github与gitlab共存"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#github与gitlab共存"}},[t._v("#")]),t._v(" github与gitlab共存")]),t._v(" "),n("p",[t._v("假设我们之前就已经生成了 "),n("code",[t._v("github")]),t._v(" 的 "),n("code",[t._v("ssh")]),t._v(" 密匙:")]),t._v(" "),n("div",{staticClass:"language- extra-class"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[t._v("github_id_rsa\ngithub_id_rsa.pub\n")])])]),n("p",[t._v("在我们电脑的用户目录 "),n("code",[t._v("/.ssh/")]),t._v(" 下创建 "),n("code",[t._v("config")]),t._v(" 文件，配置如下，保存即可:")]),t._v(" "),n("div",{staticClass:"language-shell extra-class"},[n("pre",{pre:!0,attrs:{class:"language-shell"}},[n("code",[n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("#github")]),t._v("\nHost github.com\nHostName github.com\nIdentityFile C:/Users/jwchan/.ssh/github_id_rsa\n\n"),n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("#gitlab")]),t._v("\nHost "),n("span",{pre:!0,attrs:{class:"token number"}},[t._v("192.168")]),t._v(".2.192\nHostName "),n("span",{pre:!0,attrs:{class:"token number"}},[t._v("192.168")]),t._v(".2.192\nIdentityFile C:/Users/jwchan/.ssh/gitlab_id_rsa\n")])])]),n("p",[t._v("这样，我们在提交代码的时候，会自动区分目标服务器从而使用对应的 "),n("code",[t._v("ssh")]),t._v(" 密匙。")]),t._v(" "),n("h3",{attrs:{id:"git基本操作"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#git基本操作"}},[t._v("#")]),t._v(" git基本操作")]),t._v(" "),n("ol",[n("li",[t._v("拉取仓库")])]),t._v(" "),n("div",{staticClass:"language-bash extra-class"},[n("pre",{pre:!0,attrs:{class:"language-bash"}},[n("code",[t._v("$ "),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("git")]),t._v(" clone ssh://git@192.168.2.192:10022/jwchan/blog.git\n")])])]),n("ol",{attrs:{start:"2"}},[n("li",[t._v("进入仓库贡献代码")])]),t._v(" "),n("div",{staticClass:"language-bash extra-class"},[n("pre",{pre:!0,attrs:{class:"language-bash"}},[n("code",[t._v("$ "),n("span",{pre:!0,attrs:{class:"token builtin class-name"}},[t._v("cd")]),t._v(" /blog/\n")])])]),n("ol",{attrs:{start:"3"}},[n("li",[t._v("查看仓库代码修改状态")])]),t._v(" "),n("div",{staticClass:"language-bash extra-class"},[n("pre",{pre:!0,attrs:{class:"language-bash"}},[n("code",[t._v("$ "),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("git")]),t._v(" status\n")])])]),n("ol",{attrs:{start:"4"}},[n("li",[t._v("添加代码缓冲区")])]),t._v(" "),n("div",{staticClass:"language-bash extra-class"},[n("pre",{pre:!0,attrs:{class:"language-bash"}},[n("code",[t._v("$ "),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("git")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("add")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token builtin class-name"}},[t._v(".")]),t._v("\n")])])]),n("ol",{attrs:{start:"5"}},[n("li",[t._v("提交代码并注释")])]),t._v(" "),n("div",{staticClass:"language-bash extra-class"},[n("pre",{pre:!0,attrs:{class:"language-bash"}},[n("code",[t._v("$ "),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("git")]),t._v(" commit -m "),n("span",{pre:!0,attrs:{class:"token string"}},[t._v('"[fix]: bug"')]),t._v("\n")])])]),n("ol",{attrs:{start:"6"}},[n("li",[t._v("推送代码到远程仓库")])]),t._v(" "),n("div",{staticClass:"language-bash extra-class"},[n("pre",{pre:!0,attrs:{class:"language-bash"}},[n("code",[t._v("$ "),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("git")]),t._v(" push \n")])])])])}),[],!1,null,null,null);a.default=e.exports}}]);