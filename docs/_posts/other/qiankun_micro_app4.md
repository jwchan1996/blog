---
title: qiankun å¾®å‰ç«¯åº”ç”¨å®è·µä¸éƒ¨ç½²ï¼ˆå››ï¼‰
date: 2020-09-14
categories: "other" #åˆ†ç±»
tags:  #æ ‡ç­¾
    - qiankun
    - micro-frontend
---

# qiankun å¾®å‰ç«¯åº”ç”¨å®è·µä¸éƒ¨ç½²ï¼ˆå››ï¼‰

ä¸€èˆ¬æƒ…å†µä¸‹ï¼Œæˆ‘ä»¬å¯¹åº”ç”¨è¿›è¡Œé…ç½®æ‰“åŒ…ï¼Œè¦å¯¹å›¾ç‰‡å­—ä½“ç­‰èµ„æºè¿›è¡Œä¸‹é¢é…ç½®ï¼Œä½¿å¾—èµ„æºè·¯å¾„æ­£å¸¸åŠ è½½ã€‚ä½†æ˜¯ï¼Œåœ¨å¾®å‰ç«¯æ¨¡å¼ä¸‹ï¼Œå­åº”ç”¨æ‰“åŒ…éƒ¨ç½²åï¼Œå¾€å¾€ä¼šå‡ºç°å­åº”ç”¨ `css` æ–‡ä»¶é‡Œé¢å¼•å…¥èµ„æºè·¯å¾„åŠ è½½å¤±è´¥çš„é—®é¢˜ï¼Œä¸‹é¢å°±è®©æˆ‘ä»¬æ¥æ¢ç©¶ä¸€ä¸‹ã€‚

ğŸ‘‰ ç‹¬ç«‹åº”ç”¨ä¸‹çš„ `url-loader` é…ç½®ï¼š

```javascript
// vue-cli 2 å†™æ³•

module: {
  rules: [
    {
      test: /\.(png|jpe?g|gif|svg)(\?.*)?$/,
      loader: "url-loader",
      options: {
        limit: 10000,
        // æ­¤å¤„çš„ utils.assetsPath æ˜¯å‡½æ•°ï¼Œè¿”å›æ ¹æ®é…ç½®é¡¹æ‹¼æ¥å¥½çš„è·¯å¾„ï¼Œå¦‚ static/img/[name].[hash:7].[ext] 
        name: utils.assetsPath("img/[name].[hash:7].[ext]")
      }
    },
    {
      test: /\.(woff2?|eot|ttf|otf)(\?.*)?$/,
      loader: "url-loader",
      options: {
        limit: 10000,
        // æ­¤å¤„çš„ utils.assetsPath æ˜¯å‡½æ•°ï¼Œè¿”å›æ ¹æ®é…ç½®é¡¹æ‹¼æ¥å¥½çš„è·¯å¾„ï¼Œå¦‚ static/fonts/[name].[hash:7].[ext] 
        name: utils.assetsPath("fonts/[name].[hash:7].[ext]")
      }
    }
  ]
}
```

å› ä¸º `url-loader` çš„ `options` é¡¹çš„å±æ€§ `publicPath` å±æ€§é»˜è®¤æ˜¯ `''`ï¼Œè¡¨ç¤ºç›¸å¯¹è·¯å¾„ï¼Œå³æ‰“åŒ…å‡ºæ¥çš„èµ„æºå¼•ç”¨ `url` éƒ½ä¼šåŠ ä¸Šç›¸å¯¹è·¯å¾„å¯»æ‰¾ `static` é™æ€èµ„æºå…¥å£ï¼Œæ¯”å¦‚ï¼š

```css
/* static/css/app.e99e9aae.css */

background-header {
    background: url(../../static/img/bg_header.790a94f4.png);
}
```

æ‰€æœ‰åº”ç”¨ç¼–è¯‘æ‰“åŒ…éƒ¨ç½²åï¼Œå½“ä¸»åº”ç”¨åŠ è½½å­åº”ç”¨ï¼Œå­åº”ç”¨åŠ è½½è‡ªèº«çš„ `css` æ–‡ä»¶æ ·å¼æ—¶ï¼Œç”±äº å…¶å¯¹åº”çš„ css æ–‡ä»¶é‡Œé¢çš„å›¾ç‰‡ `url` å¼•ç”¨æ˜¯ç›¸å¯¹è·¯å¾„ï¼Œä¼šå‡ºç°å­åº”ç”¨çš„èµ„æºç›¸å¯¹è·¯å¾„æ‹¼æ¥ä¸»åº”ç”¨ `domain` çš„æƒ…å†µï¼Œå³å­åº”ç”¨çš„ `../../static/img/bg_header.790a94f4.png` ä¼šåœ¨ä¸»åº”ç”¨çš„ `domain` ä¸‹è¿›è¡Œèµ„æºçš„å¯»æ‰¾ï¼Œå¯¼è‡´åŠ è½½å¤±è´¥ `404` çš„æƒ…å†µã€‚

## è§£å†³æ‰“åŒ…åçš„ css èƒŒæ™¯å›¾ç‰‡ä¸å­—ä½“å›¾æ ‡è·¯å¾„é—®é¢˜

å¦‚æœé¡¹ç›®æœ‰ç”¨åˆ°ç¬¬ä¸‰æ–¹åº“ï¼Œæ¯”å¦‚ `element-ui`ï¼Œé‚£ä¹ˆå°±æ›´æœ‰å¿…è¦è¿›è¡Œå¤„ç†äº†ã€‚å› ä¸º `element-ui` çš„å­—ä½“å›¾æ ‡æ˜¯åœ¨ `css` é‡Œé¢å¼•å…¥çš„ï¼Œè¿˜æœ‰ç›¸å…³èƒŒæ™¯å›¾ç‰‡çš„å¼•å…¥ä¹Ÿæ˜¯åœ¨ `css` é‡Œï¼Œæ‰€ä»¥éœ€è¦é…ç½® `webpack` çš„ `url-loader`ï¼Œç”Ÿäº§æ¨¡å¼æƒ…å†µä¸‹ç›´æ¥æŒ‡å®šèµ„æºå‰ç¼€ï¼Œä½¿ä¹‹æˆä¸ºç»å¯¹è·¯å¾„ã€‚

```javascript
module: {
  rules: [
    {
      test: /\.(png|jpe?g|gif|svg)(\?.*)?$/,
      loader: "url-loader",
      options: {
        limit: 10000,
        name: utils.assetsPath("img/[name].[hash:7].[ext]"),
        //è¿™é‡Œ 192.168.2.192ï¼š7100 æ˜¯å­åº”ç”¨éƒ¨ç½²åœ°å€
        publicPath: process.env.NODE_ENV === 'production' ? '//192.168.2.192:7100' : ''
      }
    },
    {
      test: /\.(woff2?|eot|ttf|otf)(\?.*)?$/,
      loader: "url-loader",
      options: {
        limit: 10000,
        name: utils.assetsPath("fonts/[name].[hash:7].[ext]"),
        publicPath: process.env.NODE_ENV === 'production' ? '//192.168.2.192:7100' : ''
      }
    }
  ]
}
```

è¿™æ ·é…ç½®åï¼Œæ‰“åŒ…å‡ºæ¥çš„ css æ ·å¼æ–‡ä»¶ä¼šå˜æˆï¼š

```css
/* static/css/app.e99e9aae.css */

background-header {
    background: url(//192.168.2.192:7100/static/img/bg_header.790a94f4.png);
}
```

èµ„æºæ˜¯ç»å¯¹è·¯å¾„ï¼Œå°±ä¸ä¼šå‡ºç°ä¸Šé¢å­åº”ç”¨èµ„æºåŠ è½½å¤±è´¥çš„æƒ…å†µã€‚

ä½†æ˜¯ï¼Œè¿™ç§å‰ç«¯é…ç½®æ–‡ä»¶å†™æ­»è·¯å¾„çš„åšæ³•çµæ´»æ€§å¹¶ä¸å¥½ï¼Œæ¯”å¦‚ä¸èƒ½åšåˆ°ç¼–è¯‘ä¸€æ¬¡ï¼Œä»»æ„éƒ¨ç½²ï¼Œå› ä¸ºè·¯å¾„å†™æ­»ï¼Œæ‰€ä»¥å¦‚æœéœ€è¦éƒ¨ç½²åˆ°å…¶ä»–æœåŠ¡å™¨çš„è¯ï¼Œå°±éœ€è¦é‡æ–°ç¼–è¯‘äº†ã€‚

æ¥ä¸‹æ¥ï¼Œè®²çš„æ˜¯å®ç°çµæ´»éƒ¨ç½²çš„æ–¹æ¡ˆã€‚

## ç»“åˆ nginx é…ç½®èµ„æºå¼•ç”¨è·¯å¾„ä»£ç†è½¬å‘

æˆ‘ä»¬åœ¨åªç¼–è¯‘æ‰“åŒ…ä¸€æ¬¡å‰ç«¯åº”ç”¨çš„å‰æä¸‹ï¼Œä¸ºäº†å®ç°çµæ´»éƒ¨ç½²ï¼Œéœ€è¦å€ŸåŠ© `nginx` æ¥å®ç°ã€‚

ä¸‹é¢ä»¥ `vue-cli 3` çš„é…ç½®ä¸ºä¾‹ï¼Œä¸ `vue-cli 2` åªæ˜¯å†™æ³•ä¸Šçš„åŒºåˆ«ï¼Œå…¶ä»–éƒ½ä¸€æ ·ã€‚ 

> ä¸è¿‡ vue-cli 3 å¯¹ webpack é…ç½®è¿›è¡Œäº†æŠ½è±¡ï¼Œè¦ç†è§£é…ç½®ä¸­åŒ…å«çš„ä¸œè¥¿ä¼šæ¯”è¾ƒå›°éš¾ï¼Œå°¤å…¶æ˜¯å½“æˆ‘ä»¬éœ€è¦é‡å†™æˆ–è€…è°ƒæ•´é…ç½®çš„æ—¶å€™ï¼Œå¯ä»¥å‚è€ƒ [å®¡æŸ¥é¡¹ç›®çš„ webpack é…ç½®](https://cli.vuejs.org/zh/guide/webpack.html#å®¡æŸ¥é¡¹ç›®çš„-webpack-é…ç½®)ã€‚

```javascript
module.exports = {
  chainWebpack: (config) => 

    config.module
      .rule("fonts")
      .test(/\.(woff2?|eot|ttf|otf)(\?.*)?$/)
      .use("url-loader")
      .loader("url-loader")
      .options({
        limit: 4096,
        name: 'static/fonts/[name].[hash:8].[ext]',
        publicPath: process.env.NODE_ENV === 'production' ? '/live' : '',
      });

    config.module
      .rule("images")
      .test(/\.(png|jpe?g|gif|webp)(\?.*)?$/)
      .use("url-loader")
      .loader("url-loader")
      .options({
        limit: 4096,
        // name ä»£è¡¨ url-loader ä¼šå°†èµ„æºå†™åˆ° static/fonts/ ä¸‹
        name: 'static/img/[name].[hash:8].[ext]',
        // publicPath ä»£è¡¨èµ„æºå¼•å…¥ url ä¼šç”Ÿæˆ /live çš„å‰ç¼€ï¼Œæ¯”å¦‚ /live/static/img/bg_header.790a94f4.png
        publicPath: process.env.NODE_ENV === 'production' ? '/live' : '',
      });

  }
}
```

å‡è®¾ä¸»åº”ç”¨éƒ¨ç½²åœ°å€æ˜¯ `192.168.2.192`ï¼Œå­åº”ç”¨çš„éƒ¨ç½²åœ°å€æ˜¯ `192.168.2.192:7102`ã€‚

æ‰“åŒ…ç¼–è¯‘éƒ¨ç½²åï¼Œå­åº”ç”¨çš„ css æ–‡ä»¶é‡Œé¢çš„å›¾ç‰‡èµ„æºå¼•ç”¨ `url` å¦‚ä¸‹ï¼š

```css
/* static/css/app.e99e9aae.css */

background-header {
    background: url(/live/static/img/bg_header.790a94f4.png);
}
```

ä¸»åº”ç”¨åŠ è½½å­åº”ç”¨çš„æ—¶å€™ï¼Œå­åº”ç”¨çš„èµ„æºæ‹¼æ¥ä¸»åº”ç”¨ `domian` åï¼Œå­åº”ç”¨çš„ `css` æ–‡ä»¶é‡Œé¢çš„å›¾ç‰‡èµ„æºåŠ è½½è·¯å¾„ `url` å°±ä¼šå˜æˆï¼š

```bash
192.168.2.192/live/static/img/bg_header.790a94f4.png
```

æ­¤æ—¶çš„å…³é”®å°±æ˜¯è¦è®¿é—®åˆ°å­åº”ç”¨çš„èµ„æºï¼Œè€Œä¸æ˜¯å»ä¸»åº”ç”¨èµ„æºç›®å½•å»æ‰¾ã€‚

æ‰€ä»¥æˆ‘ä»¬é‡‡ç”¨ `nginx` è·¯å¾„ä»£ç†è½¬å‘ç«¯å£çš„æ–¹æ¡ˆï¼Œå½“åº”ç”¨è®¿é—® `192.168.2.192/live` è¿™ä¸ªè·¯å¾„æ—¶ï¼Œç»è¿‡ `nginx` è¿›è¡Œè·¯å¾„ä»£ç†è½¬å‘é…ç½®ï¼Œè½¬å‘åˆ°å­åº”ç”¨ç«¯å£ã€‚

é…ç½® `nginx` ä»£ç†è§„åˆ™ï¼š
```bash
# nginx.conf

http {
  server {
    listen	80;
    server_name 192.168.2.192;
  
    location /live {
      proxy_pass  127.0.0.1:7102

      try_files $uri $uri/ /index.html;
    }
  }
}
```

æ­¤æ—¶çœŸæ­£è®¿é—®çš„èµ„æºè·¯å¾„ï¼ˆå­åº”ç”¨èµ„æºè·¯å¾„ï¼‰æ˜¯ï¼š

```bash
192.168.2.192:7102/static/img/bg_header.790a94f4.png
```

ğŸ‘‹ è‡³æ­¤ï¼Œé€šè¿‡ä¿®æ”¹é…ç½® `url-loader` çš„ `publicPath` ä»¥åŠé…ç½® `nginx` çš„è·¯å¾„ä»£ç†è½¬å‘ï¼Œå°±å¯ä»¥å®ç°ç¼–è¯‘æ‰“åŒ…ä¸€æ¬¡ï¼Œåˆ°å¤„éƒ¨ç½²çš„ç›®çš„ã€‚