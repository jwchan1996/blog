<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>koa å®ç° token æœ‰æ•ˆæ—¶é—´ç»­æœŸçš„æ€è·¯ | é£˜é¦™è±†è…ã®åšå®¢</title>
    <meta name="generator" content="VuePress 1.5.1">
    
    <meta name="description" content="è®°å½•æŠ€æœ¯ä¸ç”Ÿæ´»">
    <link rel="preload" href="/assets/css/0.styles.1c3a77df.css" as="style"><link rel="preload" href="/assets/js/app.941f0777.js" as="script"><link rel="preload" href="/assets/js/2.7069fcb2.js" as="script"><link rel="preload" href="/assets/js/15.9c6aabc0.js" as="script"><link rel="prefetch" href="/assets/js/10.c6768422.js"><link rel="prefetch" href="/assets/js/11.007ef39d.js"><link rel="prefetch" href="/assets/js/12.47591efa.js"><link rel="prefetch" href="/assets/js/13.5979bab9.js"><link rel="prefetch" href="/assets/js/14.4657c456.js"><link rel="prefetch" href="/assets/js/16.d8606324.js"><link rel="prefetch" href="/assets/js/17.53af1abe.js"><link rel="prefetch" href="/assets/js/18.736b1255.js"><link rel="prefetch" href="/assets/js/19.158b7b67.js"><link rel="prefetch" href="/assets/js/20.ec857f98.js"><link rel="prefetch" href="/assets/js/21.dfab24b5.js"><link rel="prefetch" href="/assets/js/22.bb2332f2.js"><link rel="prefetch" href="/assets/js/23.022c5d97.js"><link rel="prefetch" href="/assets/js/24.85ee4294.js"><link rel="prefetch" href="/assets/js/25.d1032259.js"><link rel="prefetch" href="/assets/js/26.334b52ad.js"><link rel="prefetch" href="/assets/js/27.143e931b.js"><link rel="prefetch" href="/assets/js/28.8d629c83.js"><link rel="prefetch" href="/assets/js/29.c47b2fc2.js"><link rel="prefetch" href="/assets/js/3.00d0631d.js"><link rel="prefetch" href="/assets/js/30.b62dc30c.js"><link rel="prefetch" href="/assets/js/31.4921932b.js"><link rel="prefetch" href="/assets/js/32.ec64dc53.js"><link rel="prefetch" href="/assets/js/33.714c4899.js"><link rel="prefetch" href="/assets/js/34.4854c585.js"><link rel="prefetch" href="/assets/js/35.bab52971.js"><link rel="prefetch" href="/assets/js/4.3ae0012c.js"><link rel="prefetch" href="/assets/js/5.9a32b28a.js"><link rel="prefetch" href="/assets/js/6.eb04f2e7.js"><link rel="prefetch" href="/assets/js/7.f9a4bb41.js"><link rel="prefetch" href="/assets/js/8.b462eb05.js"><link rel="prefetch" href="/assets/js/9.b7b5193a.js">
    <link rel="stylesheet" href="/assets/css/0.styles.1c3a77df.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><img src="/logo.png" alt="é£˜é¦™è±†è…ã®åšå®¢" class="logo"> <span class="site-name can-hide">é£˜é¦™è±†è…ã®åšå®¢</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/" class="nav-link">
  ä¸»é¡µ
</a></div><div class="nav-item"><a href="/archives/" class="nav-link">
  å½’æ¡£
</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="åˆ†ç±»" class="dropdown-title"><span class="title">åˆ†ç±»</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><h4>
          å‰ç«¯
        </h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/_posts/frontend/vue/" class="nav-link">
  vue
</a></li><li class="dropdown-subitem"><a href="/_posts/frontend/react/" class="nav-link">
  react
</a></li><li class="dropdown-subitem"><a href="/_posts/frontend/javascript/" class="nav-link">
  javascript
</a></li><li class="dropdown-subitem"><a href="/_posts/frontend/typescript/" class="nav-link">
  typescript
</a></li></ul></li><li class="dropdown-item"><h4>
          åç«¯
        </h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/_posts/backend/node/" class="nav-link router-link-active">
  node
</a></li><li class="dropdown-subitem"><a href="/_posts/backend/deno/" class="nav-link">
  deno
</a></li><li class="dropdown-subitem"><a href="/_posts/backend/go/" class="nav-link">
  go
</a></li><li class="dropdown-subitem"><a href="/_posts/backend/rust/" class="nav-link">
  rust
</a></li></ul></li><li class="dropdown-item"><h4>
          å·¥å…·
        </h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/_posts/tool/docker/" class="nav-link">
  docker
</a></li><li class="dropdown-subitem"><a href="/_posts/tool/git/" class="nav-link">
  git
</a></li><li class="dropdown-subitem"><a href="/_posts/tool/webpack/" class="nav-link">
  webpack
</a></li></ul></li><li class="dropdown-item"><h4>
          è·¨ç«¯
        </h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/_posts/across/flutter/" class="nav-link">
  flutter
</a></li><li class="dropdown-subitem"><a href="/_posts/across/electron/" class="nav-link">
  electron
</a></li></ul></li><li class="dropdown-item"><h4>
          ç¬¬ä¸‰æ–¹åº“
        </h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/_posts/plugin/axios/" class="nav-link">
  axios
</a></li></ul></li><li class="dropdown-item"><h4>
          å…¶ä»–
        </h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/_posts/other/" class="nav-link">
  æœªåˆ†ç±»
</a></li></ul></li></ul></div></div><div class="nav-item"><a href="/about/" class="nav-link">
  å…³äº
</a></div><div class="nav-item"><a href="https://github.com/jwchan1996/blog" target="_blank" rel="noopener noreferrer" class="nav-link external">
  GitHub
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/" class="nav-link">
  ä¸»é¡µ
</a></div><div class="nav-item"><a href="/archives/" class="nav-link">
  å½’æ¡£
</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="åˆ†ç±»" class="dropdown-title"><span class="title">åˆ†ç±»</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><h4>
          å‰ç«¯
        </h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/_posts/frontend/vue/" class="nav-link">
  vue
</a></li><li class="dropdown-subitem"><a href="/_posts/frontend/react/" class="nav-link">
  react
</a></li><li class="dropdown-subitem"><a href="/_posts/frontend/javascript/" class="nav-link">
  javascript
</a></li><li class="dropdown-subitem"><a href="/_posts/frontend/typescript/" class="nav-link">
  typescript
</a></li></ul></li><li class="dropdown-item"><h4>
          åç«¯
        </h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/_posts/backend/node/" class="nav-link router-link-active">
  node
</a></li><li class="dropdown-subitem"><a href="/_posts/backend/deno/" class="nav-link">
  deno
</a></li><li class="dropdown-subitem"><a href="/_posts/backend/go/" class="nav-link">
  go
</a></li><li class="dropdown-subitem"><a href="/_posts/backend/rust/" class="nav-link">
  rust
</a></li></ul></li><li class="dropdown-item"><h4>
          å·¥å…·
        </h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/_posts/tool/docker/" class="nav-link">
  docker
</a></li><li class="dropdown-subitem"><a href="/_posts/tool/git/" class="nav-link">
  git
</a></li><li class="dropdown-subitem"><a href="/_posts/tool/webpack/" class="nav-link">
  webpack
</a></li></ul></li><li class="dropdown-item"><h4>
          è·¨ç«¯
        </h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/_posts/across/flutter/" class="nav-link">
  flutter
</a></li><li class="dropdown-subitem"><a href="/_posts/across/electron/" class="nav-link">
  electron
</a></li></ul></li><li class="dropdown-item"><h4>
          ç¬¬ä¸‰æ–¹åº“
        </h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/_posts/plugin/axios/" class="nav-link">
  axios
</a></li></ul></li><li class="dropdown-item"><h4>
          å…¶ä»–
        </h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/_posts/other/" class="nav-link">
  æœªåˆ†ç±»
</a></li></ul></li></ul></div></div><div class="nav-item"><a href="/about/" class="nav-link">
  å…³äº
</a></div><div class="nav-item"><a href="https://github.com/jwchan1996/blog" target="_blank" rel="noopener noreferrer" class="nav-link external">
  GitHub
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div> <!----></nav>  <ul class="sidebar-links"><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading open"><span>Node</span> <span class="arrow down"></span></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/_posts/backend/node/koa_token.html" aria-current="page" class="active sidebar-link">koa å®ç° token æœ‰æ•ˆæ—¶é—´ç»­æœŸçš„æ€è·¯</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/_posts/backend/node/koa_token.html#åœºæ™¯æè¿°" class="sidebar-link">åœºæ™¯æè¿°</a></li><li class="sidebar-sub-header"><a href="/_posts/backend/node/koa_token.html#åˆ†ææ€è·¯" class="sidebar-link">åˆ†ææ€è·¯</a></li><li class="sidebar-sub-header"><a href="/_posts/backend/node/koa_token.html#å¤„ç†æ€è·¯" class="sidebar-link">å¤„ç†æ€è·¯</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/_posts/backend/node/koa_token.html#ä»£ç å®ç°" class="sidebar-link">ä»£ç å®ç°</a></li></ul></li></ul></li><li><a href="/_posts/backend/node/koa_jwt_unless.html" class="sidebar-link">koa-jwt å®ç°è‡ªå®šä¹‰æ’é™¤åŠ¨æ€è·¯ç”±çš„é‰´æƒ</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/_posts/backend/node/koa_jwt_unless.html#åœºæ™¯æè¿°" class="sidebar-link">åœºæ™¯æè¿°</a></li><li class="sidebar-sub-header"><a href="/_posts/backend/node/koa_jwt_unless.html#è§£å†³æ–¹æ³•" class="sidebar-link">è§£å†³æ–¹æ³•</a></li></ul></li></ul></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="koa-å®ç°-token-æœ‰æ•ˆæ—¶é—´ç»­æœŸçš„æ€è·¯"><a href="#koa-å®ç°-token-æœ‰æ•ˆæ—¶é—´ç»­æœŸçš„æ€è·¯" class="header-anchor">#</a> koa å®ç° token æœ‰æ•ˆæ—¶é—´ç»­æœŸçš„æ€è·¯</h1> <h2 id="åœºæ™¯æè¿°"><a href="#åœºæ™¯æè¿°" class="header-anchor">#</a> åœºæ™¯æè¿°</h2> <p>ğŸ­ åœ¨å‰åç«¯çš„äº¤äº’ä¸­ï¼Œæ— å¯é¿å…çš„å­˜åœ¨ä¸€äº›éœ€è¦éªŒè¯èº«ä»½çš„è¯·æ±‚ã€‚<br>
ğŸ­ ä¸€èˆ¬æ¥è¯´ï¼Œä½¿ç”¨ <code>token</code> ä½œä¸ºèº«ä»½ä»¤ç‰Œå¯ä»¥å®ç°èº«ä»½éªŒè¯çš„é—®é¢˜ã€‚<br>
ğŸ­ ä»¥æ­¤åŒæ—¶ï¼Œ<code>token</code> ä½œä¸ºè‡ªå¸¦æè¿°ä¿¡æ¯çš„æ— çŠ¶æ€æ•°æ®ï¼Œå”¯ä¸€çš„åˆ¤æ–­æ ‡å‡†å°±æ˜¯ç”Ÿæˆ <code>token</code> æ—¶è®¾ç½®çš„æœ‰æ•ˆæœŸæ—¶é—´ï¼Œå½“è¶…è¿‡æœ‰æ•ˆæœŸæ—¶åˆ™ä½œåºŸã€‚<br>
ğŸ­ æˆ‘ä»¬åœ¨ä½¿ç”¨ <code>APP</code> æˆ– <code>WEB</code> åº”ç”¨æ—¶ï¼Œå¦‚æœæ­£åœ¨æ“ä½œçš„æ—¶å€™ï¼Œ<code>token</code> åˆšå¥½è¿‡æœŸäº†ï¼Œé‚£å°±å‡ºå¤§é—®é¢˜äº†ã€‚<br>
ğŸ­ æ‰€æœ‰çš„æ•°æ®è¯·æ±‚éƒ½ä¼šå¤±è´¥ï¼Œç»™ç”¨æˆ·å¸¦æ¥æå…¶ç³Ÿç³•çš„ä½“éªŒã€‚<br>
ğŸ­ æ‰€ä»¥ï¼Œå¦‚ä½•æ‰èƒ½è®© <code>token</code> è¿›è¡Œç»­æœŸå‘¢ï¼Ÿ</p> <h2 id="åˆ†ææ€è·¯"><a href="#åˆ†ææ€è·¯" class="header-anchor">#</a> åˆ†ææ€è·¯</h2> <p>ğŸ¤ å› ä¸º <code>token</code> æ˜¯æ— çŠ¶æ€æ•°æ®ï¼Œä¸€æ—¦ç”Ÿæˆäº†ï¼Œä¸èƒ½ä¸»åŠ¨åˆ é™¤æˆ–è€…è®©å®ƒå¤±æ•ˆï¼Œå”¯ä¸€çš„å°±æ˜¯ç­‰å¾…æœ‰æ•ˆæœŸæ—¶é—´åˆ°ã€‚<br>
ğŸ¤ æ‰€ä»¥ï¼Œæˆ‘ä»¬ä¼šæƒ³åˆ°ï¼Œåœ¨ <code>token</code> è¿‡æœŸæ—¶å®¢æˆ·ç«¯æºå¸¦æ–°çš„ <code>token</code> æ¥è®¿é—®æ•°æ®æ¥å£ï¼Œæ˜¯ä¸æ˜¯å°±å¯ä»¥äº†å‘¢ã€‚<br>
ğŸ¤ ç­”æ¡ˆæ˜¯çš„ï¼Œé‚£ä¹ˆç°åœ¨éœ€è¦è§£å†³çš„é—®é¢˜å°±æ˜¯ï¼š</p> <div class="language-bash extra-class"><pre class="language-bash"><code><span class="token number">1</span>.æ€ä¹ˆè¿”å›æ–°çš„ token ç»™åˆ°å®¢æˆ·ç«¯
<span class="token number">2</span>.ä»€ä¹ˆæ—¶å€™è¿”å› token ä½¿å¾—ç”¨æˆ·ç™»å½•çŠ¶æ€å¾—åˆ°ç»­æœŸ
</code></pre></div><h2 id="å¤„ç†æ€è·¯"><a href="#å¤„ç†æ€è·¯" class="header-anchor">#</a> å¤„ç†æ€è·¯</h2> <ol><li>é€šè¿‡è®¾ç½®è¿”å›å¤´è®¾ç½®æ–° <code>token</code> çš„å€¼ï¼Œå®¢æˆ·ç«¯ä½¿ç”¨ <code>axios</code> è¿›è¡Œå“åº”æ‹¦æˆªåˆ¤æ–­æ˜¯å¦æœ‰æ–° <code>token</code> å­—æ®µï¼Œæœ‰åˆ™ä¿å­˜èµ·æ¥ã€‚</li> <li>å¦‚æœç”¨æˆ·åœ¨ä¸€å®šçš„ <code>token</code> æœ‰æ•ˆæ—¶é—´æ®µæœŸé—´ï¼ˆæ¯”å¦‚æœ‰æ•ˆæœŸæ—¶é—´çš„ååŠæ®µï¼‰è®¿é—®äº†æ•°æ®æ¥å£ï¼Œå°±åº”è¯¥å¯¹ <code>token</code> è¿›è¡Œç»­æœŸã€‚</li></ol> <h3 id="ä»£ç å®ç°"><a href="#ä»£ç å®ç°" class="header-anchor">#</a> ä»£ç å®ç°</h3> <p>ğŸ¥ æœ¬æ¬¡é¡¹ç›®é‡‡ç”¨çš„æ˜¯ <code>koa</code> åŸºäº <code>node</code> å®ç°çš„ <code>api</code> æœåŠ¡ç«¯ã€‚<br>
ğŸ¥ ä¸»è¦æ–‡ä»¶æœ‰ä¸¤ä¸ªï¼Œä¸€ä¸ªæ˜¯å…¥å£æ–‡ä»¶ <code>app.js</code>ï¼Œå¦ä¸€ä¸ªæ˜¯å·¥å…·å‡½æ•°æ–‡ä»¶ <code>token.js</code>ã€‚<br>
ğŸ¥ å®Œæ•´ <code>github</code> é¡¹ç›®å¯ä»¥æŸ¥çœ‹ <a href="https://github.com/ppap6/PPAP.server" target="_blank" rel="noopener noreferrer">PPAP.server<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>ã€‚</p> <div class="language-JavaScript extra-class"><pre class="language-javascript"><code><span class="token comment">//token.js</span>

<span class="token keyword">const</span> jwt <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'jsonwebtoken'</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> secret <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'../config/config'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>secret

<span class="token comment">//åˆ¤æ–­tokenæ˜¯å¦åº”è¯¥æ›´æ–°æœ‰æ•ˆæœŸï¼ˆç»­æœŸï¼‰</span>
<span class="token keyword">const</span> <span class="token function-variable function">getTokenRenewStatus</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>

  <span class="token comment">//æ£€æµ‹å½“å‰tokenæ˜¯å¦åˆ°è¾¾ç»­æœŸæ—¶é—´æ®µ</span>
  <span class="token keyword">let</span> obj <span class="token operator">=</span> <span class="token function">parseToken</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span>obj<span class="token punctuation">.</span>email<span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token boolean">false</span>
  <span class="token punctuation">}</span>
  <span class="token comment">//æ›´æ–°æ—¶é—´æ®µåœ¨è¿‡æœŸå‰3å¤©</span>
  <span class="token keyword">if</span><span class="token punctuation">(</span>obj<span class="token punctuation">.</span>exp <span class="token operator">-</span> <span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">/</span><span class="token number">1000</span> <span class="token operator">&gt;</span> <span class="token number">60</span><span class="token operator">*</span><span class="token number">60</span><span class="token operator">*</span><span class="token number">24</span><span class="token operator">*</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token boolean">false</span>
  <span class="token punctuation">}</span><span class="token keyword">else</span><span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token boolean">true</span>
  <span class="token punctuation">}</span>

<span class="token punctuation">}</span>

<span class="token comment">//è·å–ä¸€ä¸ªæœŸé™ä¸º7å¤©çš„token</span>
<span class="token keyword">const</span> <span class="token function-variable function">getToken</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">payload <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span></span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> jwt<span class="token punctuation">.</span><span class="token function">sign</span><span class="token punctuation">(</span>payload<span class="token punctuation">,</span> secret<span class="token punctuation">,</span> <span class="token punctuation">{</span> expiresIn<span class="token operator">:</span> <span class="token number">60</span><span class="token operator">*</span><span class="token number">60</span><span class="token operator">*</span><span class="token number">24</span><span class="token operator">*</span><span class="token number">7</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token comment">//é‡æ–°ç”Ÿæˆä¸€ä¸ªæœŸé™ä¸º7å¤©çš„token</span>
<span class="token keyword">const</span> <span class="token function-variable function">createNewToken</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>

  <span class="token keyword">let</span> token <span class="token operator">=</span> global<span class="token punctuation">.</span>token
  <span class="token keyword">let</span> obj <span class="token operator">=</span> jwt<span class="token punctuation">.</span><span class="token function">verify</span><span class="token punctuation">(</span>token<span class="token punctuation">,</span> secret<span class="token punctuation">)</span>
  <span class="token keyword">let</span> payload <span class="token operator">=</span> <span class="token punctuation">{</span>
    uid<span class="token operator">:</span> obj<span class="token punctuation">.</span>uid<span class="token punctuation">,</span>
    name<span class="token operator">:</span> obj<span class="token punctuation">.</span>name<span class="token punctuation">,</span>
    account<span class="token operator">:</span> obj<span class="token punctuation">.</span>account<span class="token punctuation">,</span>
    roleId<span class="token operator">:</span> obj<span class="token punctuation">.</span>roleId<span class="token punctuation">,</span>
    email<span class="token operator">:</span> obj<span class="token punctuation">.</span>email<span class="token punctuation">,</span>
    password<span class="token operator">:</span> obj<span class="token punctuation">.</span>password
  <span class="token punctuation">}</span>
  <span class="token keyword">return</span> <span class="token function">getToken</span><span class="token punctuation">(</span>payload<span class="token punctuation">)</span>

<span class="token punctuation">}</span>

<span class="token comment">//è§£ætokenä¸ºå¯¹è±¡</span>
<span class="token keyword">const</span> <span class="token function-variable function">parseToken</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  
  <span class="token keyword">let</span> token <span class="token operator">=</span> global<span class="token punctuation">.</span>token
  <span class="token keyword">try</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> jwt<span class="token punctuation">.</span><span class="token function">verify</span><span class="token punctuation">(</span>token<span class="token punctuation">,</span> secret<span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token keyword">catch</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'token is expired'</span><span class="token punctuation">)</span>
    <span class="token keyword">return</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
  
<span class="token punctuation">}</span>

module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token punctuation">{</span>
  secret<span class="token punctuation">,</span>
  getTokenRenewStatus<span class="token punctuation">,</span>
  getToken<span class="token punctuation">,</span>
  createNewToken<span class="token punctuation">,</span>
  parseToken
<span class="token punctuation">}</span>
</code></pre></div><div class="language-JavaScript extra-class"><pre class="language-javascript"><code><span class="token comment">//app.js</span>

<span class="token keyword">const</span> Koa <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'koa'</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> bodyParser <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'koa-bodyparser'</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> jwtKoa <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'koa-jwt'</span><span class="token punctuation">)</span>  <span class="token comment">// ç”¨äºè·¯ç”±æƒé™æ§åˆ¶</span>
<span class="token keyword">const</span> app <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Koa</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token keyword">const</span> config <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'./config/config'</span><span class="token punctuation">)</span>

<span class="token keyword">const</span> tokenUtil <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'./util/token'</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> router <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'./router'</span><span class="token punctuation">)</span>

<span class="token keyword">const</span> jwtUnless <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'./util/jwt_unless'</span><span class="token punctuation">)</span>  <span class="token comment">//ç”¨äºåˆ¤æ–­æ˜¯å¦éœ€è¦jwtéªŒè¯</span>

<span class="token comment">//é…ç½®ctx.bodyè§£æä¸­é—´ä»¶</span>
app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span><span class="token function">bodyParser</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

<span class="token comment">// é”™è¯¯å¤„ç†</span>
app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">ctx<span class="token punctuation">,</span> next</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token comment">//è®¾ç½®CORSè·¨åŸŸ</span>
  ctx<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token string">&quot;Access-Control-Allow-Origin&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;*&quot;</span><span class="token punctuation">)</span>
  ctx<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token string">&quot;Access-Control-Allow-Methods&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;OPTIONS, GET, PUT, POST, DELETE&quot;</span><span class="token punctuation">)</span>
  ctx<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token string">&quot;Access-Control-Allow-Headers&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;x-requested-with, accept, origin, content-type, Authorization&quot;</span><span class="token punctuation">)</span>
  ctx<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token string">&quot;Content-Type&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;application/json;charset=utf-8&quot;</span><span class="token punctuation">)</span>
  ctx<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token string">&quot;Access-Control-Expose-Headers&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;new_token&quot;</span><span class="token punctuation">)</span>
  <span class="token comment">//è·å–tokenï¼Œä¿å­˜å…¨å±€å˜é‡</span>
  <span class="token keyword">if</span><span class="token punctuation">(</span>ctx<span class="token punctuation">.</span>request<span class="token punctuation">.</span>header<span class="token punctuation">.</span>authorization<span class="token punctuation">)</span><span class="token punctuation">{</span>
    global<span class="token punctuation">.</span>token <span class="token operator">=</span> ctx<span class="token punctuation">.</span>request<span class="token punctuation">.</span>header<span class="token punctuation">.</span>authorization<span class="token punctuation">.</span><span class="token function">split</span><span class="token punctuation">(</span><span class="token string">' '</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span>
    <span class="token comment">//æ£€æµ‹å½“å‰tokenæ˜¯å¦åˆ°è¾¾ç»­æœŸæ—¶é—´æ®µ</span>
    <span class="token keyword">let</span> obj <span class="token operator">=</span> tokenUtil<span class="token punctuation">.</span><span class="token function">parseToken</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token comment">//è§£ætokenæºå¸¦çš„ä¿¡æ¯</span>
    global<span class="token punctuation">.</span>uid <span class="token operator">=</span> obj<span class="token punctuation">.</span>uid
    global<span class="token punctuation">.</span>name <span class="token operator">=</span> obj<span class="token punctuation">.</span>name
    global<span class="token punctuation">.</span>account <span class="token operator">=</span> obj<span class="token punctuation">.</span>account
    global<span class="token punctuation">.</span>email <span class="token operator">=</span> obj<span class="token punctuation">.</span>email
    global<span class="token punctuation">.</span>roleId <span class="token operator">=</span> obj<span class="token punctuation">.</span>roleId
    <span class="token comment">//å…ˆè§£æå…¨å±€å˜é‡å†æ‰§è¡Œnext()ï¼Œä¿è¯å‡½æ•°å®æ—¶è·å–åˆ°å˜é‡å€¼</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">return</span> <span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token comment">//æ‰§è¡Œå®Œä¸‹é¢ä¸­é—´ä»¶åè¿›å…¥</span>
    <span class="token comment">//åˆ¤æ–­ä¸éœ€è¦jwtéªŒè¯çš„æ¥å£ï¼Œè·³è¿‡tokenç»­æœŸåˆ¤æ–­</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>jwtUnless<span class="token punctuation">.</span><span class="token function">checkIsNonTokenApi</span><span class="token punctuation">(</span>ctx<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">return</span>
    <span class="token comment">//åˆ¤æ–­tokenæ˜¯å¦åº”è¯¥ç»­æœŸï¼ˆæœ‰æ•ˆæ—¶é—´ï¼‰</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>tokenUtil<span class="token punctuation">.</span><span class="token function">getTokenRenewStatus</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
      <span class="token comment">//è®¾ç½®header</span>
      ctx<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
        new_token<span class="token operator">:</span> tokenUtil<span class="token punctuation">.</span><span class="token function">createNewToken</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">catch</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">err</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      <span class="token comment">//æºå¸¦tokençš„Authorizationå‚æ•°é”™è¯¯</span>
      <span class="token keyword">if</span><span class="token punctuation">(</span>err<span class="token punctuation">.</span>status <span class="token operator">===</span> <span class="token number">401</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
          ctx<span class="token punctuation">.</span>status <span class="token operator">=</span> <span class="token number">200</span>
          ctx<span class="token punctuation">.</span>body <span class="token operator">=</span> <span class="token punctuation">{</span>
            status<span class="token operator">:</span> <span class="token number">401</span><span class="token punctuation">,</span>
            message<span class="token operator">:</span> <span class="token string">'æœªæºå¸¦tokenä»¤ç‰Œæˆ–è€…tokenä»¤ç‰Œå·²è¿‡æœŸ'</span>
          <span class="token punctuation">}</span>
      <span class="token punctuation">}</span><span class="token keyword">else</span><span class="token punctuation">{</span>
          <span class="token keyword">throw</span> err
      <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

<span class="token comment">//é…ç½®ä¸éœ€è¦jwtéªŒè¯çš„æ¥å£</span>
app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span><span class="token function">jwtKoa</span><span class="token punctuation">(</span><span class="token punctuation">{</span> secret<span class="token operator">:</span> tokenUtil<span class="token punctuation">.</span>secret <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">unless</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  <span class="token comment">//è‡ªå®šä¹‰è¿‡æ»¤å‡½æ•°ï¼Œè¯¦ç»†å‚è€ƒkoa-unless</span>
  <span class="token function-variable function">custom</span><span class="token operator">:</span> <span class="token parameter">ctx</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>jwtUnless<span class="token punctuation">.</span><span class="token function">checkIsNonTokenApi</span><span class="token punctuation">(</span>ctx<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
      <span class="token comment">//æ˜¯ä¸éœ€è¦éªŒè¯tokençš„æ¥å£</span>
      <span class="token keyword">return</span> <span class="token boolean">true</span>
    <span class="token punctuation">}</span><span class="token keyword">else</span><span class="token punctuation">{</span>
      <span class="token comment">//æ˜¯éœ€è¦éªŒè¯tokençš„æ¥å£</span>
      <span class="token keyword">return</span> <span class="token boolean">false</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">//åˆå§‹åŒ–è·¯ç”±ä¸­é—´ä»¶</span>
app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span>router<span class="token punctuation">.</span><span class="token function">routes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span>router<span class="token punctuation">.</span><span class="token function">allowedMethods</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

<span class="token comment">//ç›‘å¬å¯åŠ¨çª—å£</span>
app<span class="token punctuation">.</span><span class="token function">listen</span><span class="token punctuation">(</span>config<span class="token punctuation">.</span>port<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">PPAP.server is run on </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>config<span class="token punctuation">.</span>host<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">:</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>config<span class="token punctuation">.</span>port<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">)</span>
</code></pre></div></div> <footer class="page-edit"><!----> <div class="last-updated"><span class="prefix">ä¸Šæ¬¡æ›´æ–°:</span> <span class="time">6/17/2020, 12:09:12 PM</span></div></footer> <div class="page-nav"><p class="inner"><!----> <span class="next"><a href="/_posts/backend/node/koa_jwt_unless.html">
        koa-jwt å®ç°è‡ªå®šä¹‰æ’é™¤åŠ¨æ€è·¯ç”±çš„é‰´æƒ
      </a>
      â†’
    </span></p></div> </main></div><div class="global-ui"></div></div>
    <script src="/assets/js/app.941f0777.js" defer></script><script src="/assets/js/2.7069fcb2.js" defer></script><script src="/assets/js/15.9c6aabc0.js" defer></script>
  </body>
</html>
